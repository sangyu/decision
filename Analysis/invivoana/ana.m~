%inVivoAna
clear;

%% reading the file and getting information about the experiment
filename='12321012.abf';
[d, si, h]=abfload(filename); % load the file
fs=10^6/si; % sampling frequency
elapsedTime=h.sweepLengthInPts/fs; % total time each sweep in seconds
numOfSweeps=h.lActualEpisodes; % number of sweeps performed
%%
fprintf([filename, '\n\n']) 
fprintf(['number of sweeps = ', num2str(numOfSweeps), '\n', ...
    'elapsed time each sweep = ', num2str(elapsedTime), 's\n', ...
    'sampling frequency = ', num2str(fs), 'Hz\n' ])

if mean(max(d(:, 2, :)))>0.1
    fprintf('\nStimulation = Yes\n')
else
    fprintf('\nStimulation = No\n')
end
%% Reshape data from chanel 1 and 2
D1=reshape(d(:, 1, :), [200000 numOfSweeps]);
D2=reshape(d(:, 2, :), [200000 numOfSweeps]);

% filter out 60Hz noise

L=length(D1(:, 1));
NFFT = 2^nextpow2(L);
f = fs/2*linspace(0,1,NFFT/2+1);
Y = fft(D1,NFFT)/L;
Yf=Y;
near60=intersect(find(f>59.8), find(f<60.2));
Yf(near60, :)=0;
ylp = ifft(Y, NFFT, 'symmetric')*L;
ylpf = ifft(Yf, NFFT, 'symmetric')*L;
ylp = ylp(1:length(D1), :);
ylpf = ylpf(1:length(D1), :);


figure(1)

time=[1:length(D1(:, 1))]/fs;

for i=1:numOfSweeps
    
    plot(time, ylpf(:, i) +i*0.0005,'k' )
    hold on


stimStart=find(D2(:, i)==max(D2(:, i)));
stimEnd=find(D2(:, i)==min(D2(:, i)));
plot([stimStart, stimStart]/fs, 0.0005*[i, i+1], 'Color', [.5, .5, 0.8])
plot([stimEnd, stimEnd]/fs, 0.0005*[i, i+1], 'Color', [.5, .5, 0.8])
fill([stimStart, stimEnd, stimEnd, stimStart]/fs, 0.0005*[i+1, i+1, i, i], 'b', 'FaceAlpha', 1,'EdgeColor', 'none')
alpha(0.2)

end
xlabel('time/s')
ylabel('sweeps')
%% raster
figure(2)
subplot(211)
hold on
allspikes=zeros(length(D1(:, 1)),1);
percLower=-.1;
percUpper=.1;

if percLower<0
    lowerTh=percLower*min(min(D1));
else
    lowerTh=percLower*max(max(D1));
end
upperTh=percUpper*max(max(D1));
spikeInd=[];
waveforms=[];

for i=1:length(D1(1, :))
    try
    [ind, W]=findPeaks(D1(:, i), lowerTh, upperTh, 5, fs);
    waveforms=[waveforms;W];
    spikeInd=[spikeInd; ind];
    allspikes(ind, i)=1;
    plot( ind/fs,i*ones(1, length(ind)), 'r.')
    catch
    end
end   

xlim([0 length(D1(:, 1))/fs])
% plot([stimStart, stimStart]/fs, [0, i+1], 'Color', [.5, .5, 0.8])
% plot([stimEnd, stimEnd]/fs, [0, i+1], 'Color', [.5, .5, 0.8])
fill([stimStart, stimEnd, stimEnd, stimStart]/fs, [length(D1(1, :)), length(D1(1, :)), 0, 0], 'b', 'FaceAlpha', 1,'EdgeColor', 'none')
alpha(0.2)
xlabel('time/s')
ylabel('sweeps')

subplot(212)
hold on
sumAllSpikes=sum(allspikes ,2);
w=400;
slideTrain=[];
for i=1:length(D1(:, 1))/w-1
    ind=[(i-1)*w+1:i*w];
    segmentSum=length(find(sumAllSpikes(ind)));
    spikeRate=segmentSum/(200/fs)/length(D1(1, :))*1000;
    slideTrain=[slideTrain; spikeRate];
    fill([w*(i-1), w*i, w*i, w*(i-1)]/fs, [ spikeRate, spikeRate, 0, 0], 'k')
end
xlim([0 length(D1(:, 1))/fs])
xlabel('time/s')
ylabel('Hz')
%% spectrogram
    
figure
hold on
plot(f,2*abs(Y(1:NFFT/2+1))) 
plot(f,2*abs(Yf(1:NFFT/2+1)), 'r') 
%%
window=2000;
nOverlap=0;
P=[];
F=0:2:200;  

for i=1:length(ylpf(1, :))

    a=ylpf(:, i);
    [s, f, t, p]=spectrogram(a, window, nOverlap, F, fs, 'yaxis');
    P(:, :, i)=p;
end
figure(3)
subplot(121)
mp=mean(P, 3);

surf(t,f,10*log10(abs(mp)), 'EdgeColor','none');
axis tight;
view(0,90);

subplot(122)
plot(F,mean(mp, 2), '*-')
view(0,90);

